---
description: Workflow Pipeline 6 Phases
globs: ["scripts/**", "outputs/**"]
alwaysApply: true
---

# Pipeline FINAL TRIGGER v2 (7 Phases) ⚡ UPDATED 26 Jan 2026

| Phase | Nom | Criteres/Output |
|-------|-----|-----------------|
| 0 | Download | `data/*.parquet` |
| 1 | Screening | 200 trials, guards OFF, WFE>0.5, Sharpe>0.8, Trades>50 |
| 2 | Validation | 300 trials, 7 guards ON -> WINNERS + PENDING |
| **2B** | **Regime Stress** | **MARKDOWN + SIDEWAYS test -> PASS/EXCLU** ⚡ NEW |
| 3A | Rescue | PENDING: d26/d52/d78, 8/8 PASS -> WINNERS |
| 3B | Optimization | WINNERS: d26/d52/d78, +10% ET 8/8 PASS -> remplace |
| 4 | Filter Rescue | PENDING: baseline → moderate → conservative |
| 5 | Production | `asset_config.py` + `project-state.md` |

## Critere remplacement Phase 3B
```python
if new_sharpe > old_sharpe * 1.10 and all_guards_pass:
    use_new_displacement = True
```

## Phase 4: Filter Rescue (Refonte 2026-01-24)

### Workflow Cascade
```
Asset FAIL baseline (sensitivity > 15%)
    │
    └─→ moderate (5 filtres)
         │
         ├─ PASS → PROD ✓
         └─ FAIL → conservative (7 filtres)
                   │
                   ├─ PASS → PROD ✓
                   └─ FAIL → EXCLU ✗
```

### Filter Modes (3 modes rationnels)
| Mode | Filtres | Sensitivity | Trades OOS | WFE |
|------|---------|-------------|------------|-----|
| baseline | ichimoku only | <15% | ≥60 | ≥0.6 |
| moderate | 5 filtres | <15% | ≥50 | ≥0.6 |
| conservative | 7 filtres (+ strict) | <15% | ≥40 | ≥0.55 |

### Règles Critiques
- TOUJOURS commencer par baseline
- Max 3 tests par asset (Bonferroni ÷3)
- Si conservative FAIL → EXCLU définitif
- NE PAS chercher d'autres combinaisons (data mining)

## Commandes par Phase
```bash
# Phase 1: Screening
python scripts/run_full_pipeline.py --assets ALL --workers 6 \
    --trials-atr 100 --trials-ichi 100 --skip-guards

# Phase 2: Validation
python scripts/run_full_pipeline.py --assets WINNERS --workers 1 \
    --trials-atr 300 --trials-ichi 300 --enforce-tp-progression --run-guards

# Phase 2B: Regime Stress (NEW)
python scripts/run_regime_stress_test.py --asset ASSET --regime SIDEWAYS
python scripts/run_regime_stress_test.py --asset ASSET --regime MARKDOWN

# Phase 3A: Rescue (displacement grid)
python scripts/run_displacement_grid.py --assets PENDING

# Phase 3B: Optimization
python scripts/run_phase3b_optimization.py --assets WINNERS

# Phase 4: Filter Rescue (NOUVEAU)
python scripts/run_filter_rescue.py ASSET
python scripts/run_filter_rescue.py ETH --trials 300 --workers 1
```
