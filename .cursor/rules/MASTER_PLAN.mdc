---
description: Master Plan FINAL TRIGGER v2 Multi-Agent System
globs: ["**/*"]
alwaysApply: true
---

# MASTER PLAN ‚Äî FINAL TRIGGER v2 (v4.2)

> **Source de v√©rit√© pour les R√àGLES et PARAM√àTRES.**
> Pour l'√©tat du projet ‚Üí `status/project-state.md`
> Pour la config ‚Üí `configs/families.yaml`

---

## ‚ö†Ô∏è R√àGLES DE MISE √Ä JOUR

**CE FICHIER EST STABLE** ‚Äî Modifier uniquement si:
- Changement de seuil valid√© par tests scientifiques
- Nouveau guard ajout√©/retir√© (avec PR approuv√©e)

**OWNER:** Alex (Lead Quant) ‚Äî Approbation requise pour tout changement

---

## üìä PIPELINE v4.2

| Phase | Nom | Workers | Trials | Seuils |
|:-----:|-----|:-------:|:------:|--------|
| **1** | Screening L/S | **10** | **100** | WFE>0.5, Sharpe>0.5, Trades>50, SHORT 25-75% |
| **2** | Coupling | 1 | - | top_k_cross (k=10) |
| **3** | Baseline+WF | 1 | - | Walk-forward 5-split 60/40 |
| **4** | Guards | 1 | - | 7 hard guards |
| **5** | PBO | 1 | - | Proxy + CSCV calibr√©s |
| **6** | Portfolio | 1 | - | Corr <0.5, active_bars ‚â•150 |
| **7** | Production | 1 | - | Repro check |

---

## üõ°Ô∏è 7 HARD GUARDS (v4.2)

| Guard | Seuil | Kill |
|-------|-------|------|
| WFE | >0.6 | <0.5 |
| Trades OOS | ‚â•60 | <40 |
| Bars | ‚â•**12000** | <10000 |
| Sharpe | ‚â•0.80 | <0.5 |
| MaxDD | ‚â§35% | >50% |
| PF | ‚â•1.05 | <1.0 |
| Top10 | <40% | >50% |

---

## üìà PBO CALIBRATION (1H Timeframe)

| Param | Valeur | Justification |
|-------|--------|---------------|
| purge_bars | 120 | P95 holding period |
| embargo_bars | 240 | ~P99 holding period |
| proxy folds | 8 | Standard |
| cscv folds | 10 | Adapt√© sparsit√© returns |
| annualization | 8760 | 1H bars/year |

---

## üì¶ FAMILLES

| Famille | DOF | Description |
|---------|-----|-------------|
| A | 1 | Base L/S split, no regime |
| B | 2 | A + filtre r√©gime |
| C | 3 | B + displacement grid |

### Rescues
| Rescue | Action |
|--------|--------|
| R1 | baseline ‚Üí moderate filters |
| R2 | moderate ‚Üí conservative filters |

---

## ‚õî ANTI-PATTERNS (JAMAIS)

### 1. Look-Ahead Bias
```python
signal = indicator.shift(1)  # ‚úÖ TOUJOURS
signal = indicator           # ‚ùå INTERDIT
```

### 2. TP Non-Progressif
```python
assert tp1 < tp2 < tp3
```

### 3. Regime sur Exit Time
```python
regime = get_regime_at(entry_time)  # ‚úÖ CORRECT
regime = get_regime_at(exit_time)   # ‚ùå INTERDIT
```

### 4. R√©sultats Suspects ‚Üí CHALLENGER
- Sharpe > 4.0 ‚Üí V√©rifier
- WFE > 2.0 ‚Üí V√©rifier overfitting

### 5. Workers Phase 2+
```bash
--workers 1  # ‚úÖ OBLIGATOIRE sauf screening
```

---

## üîß COMMANDES v4.2

```bash
# Run complet
python scripts/orchestrator_v4_2.py --asset ETH --run-id v4.2_001 --family A

# Dry-run
python scripts/orchestrator_v4_2.py --asset ETH --run-id test --dry-run

# Tests
python scripts/test_v4_2_suite.py
python scripts/validate_configs.py

# Checklist
python scripts/checklist_v4_2.py --asset ETH --run-id v4.2_001
```

---

## üìÅ FICHIERS R√âF√âRENCE

| Fichier | Contenu | Owner |
|---------|---------|-------|
| `status/project-state.md` | √âtat actuel | Casey |
| `configs/families.yaml` | Config v4.2 | Alex |
| `configs/router.yaml` | State machine | Alex |
| `.cursor/rules/MASTER_PLAN.mdc` | Ce fichier | Alex |

### OBSOL√àTES
- ‚ùå `docs/HANDOFF.md`
- ‚ùå `docs/WORKFLOW_MULTI_ASSET_*.md`
- ‚ùå `run_filter_grid.py`, `run_filter_rescue.py`

---

## üéØ CONTRAINTES LIVE

| M√©trique | Backtest ‚Üí Live |
|----------|-----------------|
| Sharpe | √ó0.5-0.7 |
| MaxDD | √ó2-3 |

---

**Version**: 4.2 (28 Jan 2026)
**Migration**: 300T‚Üí100T, bars 8000‚Üí12000, PBO calibr√© P95/P99
