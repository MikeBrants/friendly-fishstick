# =============================================================================
# families.yaml ï¿½ Model Families + Rescues (v4.3, 1H)
# =============================================================================
meta:
  owner: "Alex"
  version: "4.3"
  timeframe: "1H"
  last_updated_utc: "2026-01-28"

dataset:
  bars_total: 17520
  start_utc: "2024-01-28T17:00:00Z"
  end_utc: "2026-01-27T16:00:00Z"
  notes: "2 years of 1H data; bar-level sparse returns"

holding_period_bars:
  p50: 24
  p95: 106
  p99: 230
  mean: 38
  std: 47
  min: 1
  max: 576
  sample_trades: 773

pilot_assets:
  - "ETH"
  - "DOT"
  - "SHIB"
  - "ANKR"

policy:
  random_seed: 42
  version: "4.3"

  thresholds:
    portfolio:
      method: "two_pass_backtest"
      corr_policy: "max_positive"
      corr_long_short_max: 0.50
      active_bars_min: 300

    screening:
      wfe_min: 0.50
      sharpe_min: 0.50
      trades_min: 50
      short_ratio_min: 0.25
      short_ratio_max: 0.75

    guards:
      wfe_min: 0.60
      trades_oos_min: 60
      bars_min: 12000
      sharpe_min: 0.80
      max_dd_max: 35.0
      pf_min: 1.05
      top10_concentration_max: 40.0

    pbo:
      purge_bars: 120
      embargo_bars: 240
      proxy_folds: 8
      cscv_folds: 10
      cscv_pass_threshold: 0.50

  regime:
    signal_threshold_wr_delta: 0.15
    n_trades_min_legacy: 30
    n_trades_min_total: 120
    n_trades_min_per_bucket: 80
    n_trades_min_per_window: 20
    signal_z_min: 1.65
    side_aware: true
    stability_windows: 4
    stability_pass_ratio: 0.75

    polish_oos:
      enabled: true
      max_candidates: 5
      min_candidates_agree: 3
      folds: 10
      purge_bars: 120
      embargo_bars: 240
      metric: "sharpe_oos"
      min_wins: 8
      tie_policy: "half"
      min_median_delta_sharpe: 0.05
      min_median_delta_maxdd: 3.0
      require_both: false
      logging:
        log_activation: true
        log_rejection_reason: true
        warn_activation_rate_high: 0.80
        warn_activation_rate_low: 0.05

  rescues:
    max_per_family: 2
    R1:
      type: "filter_preset"
      preset: "moderate"
      dof_change: 0
      require_pbo_pass: true
      pbo_max: 0.50
    R2:
      type: "filter_preset"
      preset: "conservative"
      dof_change: 0
      require_pbo_pass: true
      pbo_max: 0.50

  holdout:
    enabled: false
    percentage: 0.10
    min_sharpe: 0.0
    max_dd_multiplier: 1.5
    min_pf: 1.0

  displacement:
    values: 
    search_mode: "grid"
    min_positive_displacements: 2
    log_winning_displacement: true

filter_presets:
  baseline:
    active:
      - "ichimoku_filter"
      - "5in1_ichi_light"
  moderate:
    active:
      - "ichimoku_filter"
      - "5in1_ichi_light"
      - "mama_kama_filter"
      - "distance_filter"
      - "volume_filter"
  conservative:
    active:
      - "ichimoku_filter"
      - "5in1_ichi_light"
      - "mama_kama_filter"
      - "distance_filter"
      - "volume_filter"
      - "ad_line_filter"
      - "regression_filter"

regime_definitions:
  ichimoku_cloud_position:
    description: "Price position relative to Ichimoku cloud at entry time"
    parameters:
      tenkan: 13
      kijun: 34
      senkou_b: 52
      displacement: 26

families:
  A:
    description: "Base - split L/S, no regime, no displacement"
    dof_count: 1
    strategy:
      split_long_short: true
      coupled_trials: true
    filters:
      preset: "baseline"
    regime:
      enabled: false
    displacement:
      enabled: false

  B:
    description: "Regime filter wrapper"
    dof_count: 2
    inherits: "A"
    regime:
      enabled: true
      definition: "ichimoku_cloud_position"
      policy:
        bull: {long: "allow", short: "block"}
        bear: {long: "block", short: "allow"}
        sideways: {long: "allow", short: "allow"}

  C:
    description: "Regime + displacement grid"
    dof_count: 3
    inherits: "B"
    displacement:
      enabled: true
      values: [26, 52, 78]
      search_mode: "grid"
    filters:
      preset: "moderate"

rescues:
  R1:
    description: "Switch to moderate filter preset"
    type: "filter_preset"
    preset: "moderate"
    dof_change: 0

  R2:
    description: "Switch to conservative filter preset"
    type: "filter_preset"
    preset: "conservative"
    dof_change: 0
