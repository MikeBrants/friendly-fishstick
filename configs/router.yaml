# =============================================================================
# router.yaml â€” Executable State Machine (v4.2)
# =============================================================================
meta:
  owner: "Alex"
  version: "4.2"

states:
  - "INIT"
  - "SCREEN_LONG"
  - "SCREEN_SHORT"
  - "BUILD_COUPLED"
  - "BASELINE_SELECT"
  - "GUARDS"
  - "REGIME_STATS"
  - "REGIME_DECISION"
  - "POLISH_OOS"
  - "PBO_CSCV"
  - "REPRO_CHECK"
  - "PORTFOLIO_CHECK"
  - "PORTFOLIO_DECISION"
  - "FINAL_HOLDOUT"
  - "HOLDOUT_DECISION"
  - "NEXT_FAMILY"
  - "PROD_READY"
  - "REJECT"

transitions:
  INIT:
    - then: "SCREEN_LONG"
      set:
        family_id: "A"
        rescue_id: null
        families_remaining: 3
        rescues_remaining: 2

  SCREEN_LONG:
    - action: "run_screening_long"
      then: "SCREEN_SHORT"

  SCREEN_SHORT:
    - action: "run_screening_short"
      then: "BUILD_COUPLED"

  BUILD_COUPLED:
    - if: "long_candidates == 0 or short_candidates == 0"
      then: "NEXT_FAMILY"
      reason: "No candidates after screening"
    - action: "build_coupled_matrix"
      then: "BASELINE_SELECT"

  BASELINE_SELECT:
    - action: "select_and_backtest_best_couple"
      then: "GUARDS"

  GUARDS:
    - action: "run_guards"
      then: "REGIME_STATS"

  REGIME_STATS:
    - action: "run_regime_stats"
      then: "REGIME_DECISION"

  REGIME_DECISION:
    description: "Decide if regime signal detected"
    transitions:
      - if: "regime_signal_detected == True and family_id == 'A'"
        then: "POLISH_OOS"
        reason: "Regime signal detected, evaluate OOS"
      - else:
        then: "PBO_CSCV"
        reason: "No regime signal or already B/C"

  POLISH_OOS:
    description: "Compare A vs A+Gate(B) on OOS folds"
    action: "run_polish_oos_comparison"
    transitions:
      - if: "polish_decision == 'UPGRADE_TO_B'"
        then: "SCREEN_LONG"
        set:
          family_id: "B"
          regime_mode: "gate"
          rescues_remaining: 2
          polish_activated: true
        reason: "Polish OOS passed: upgrade to B"
      - if: "polish_decision == 'STAY_A'"
        then: "PBO_CSCV"
        set:
          regime_mode: "off"
          polish_activated: false
        reason: "Polish OOS: A sufficient"
      - if: "polish_decision == 'INSUFFICIENT_DATA'"
        then: "PBO_CSCV"
        set:
          regime_mode: "off"
          regime_insufficient_data: true
        reason: "Not enough trades per bucket"

  PBO_CSCV:
    - action: "compute_pbo_cscv"
      then: "REPRO_CHECK"

  REPRO_CHECK:
    - action: "run_repro_check"
      then: "PORTFOLIO_CHECK"

  PORTFOLIO_CHECK:
    - action: "run_portfolio_check"
      then: "PORTFOLIO_DECISION"

  PORTFOLIO_DECISION:
    - if: "portfolio_passed is False"
      then: "REJECT"
      reason: "Portfolio check failed"
    - if: "holdout_enabled is True"
      then: "FINAL_HOLDOUT"
    - then: "PROD_READY"

  FINAL_HOLDOUT:
    - action: "run_final_holdout_check"
      then: "HOLDOUT_DECISION"

  HOLDOUT_DECISION:
    - if: "holdout_passed is False"
      then: "REJECT"
      reason: "Final holdout failed"
    - then: "PROD_READY"

  NEXT_FAMILY:
    - if: "families_remaining <= 1"
      then: "REJECT"
      reason: "All families exhausted"
    - if: "family_id == 'A'"
      then: "SCREEN_LONG"
      set: {family_id: "B", rescue_id: null, rescues_remaining: 2, families_remaining: 2}
    - if: "family_id == 'B'"
      then: "SCREEN_LONG"
      set: {family_id: "C", rescue_id: null, rescues_remaining: 2, families_remaining: 1}
    - if: "family_id == 'C'"
      then: "REJECT"
      reason: "Family C exhausted"

  PROD_READY:
    - terminal: true

  REJECT:
    - terminal: true
