---
description: Regles quant obligatoires FINAL TRIGGER v2 - Applique a TOUS les agents
globs: ["**/*.py", "**/*.md", "outputs/**"]
alwaysApply: true
---

# Protocole Quant Multi-Agent FINAL TRIGGER v2

## ALERTE CRITIQUE
Tous les resultats datant d'AVANT 2026-01-22 12H00 sont INVALIDES.
Le bug TP progression est maintenant fixe (--enforce-tp-progression).

## 8 GUARDS OBLIGATOIRES (validation avant merge) ⚡ UPDATED 26 Jan 2026
| Guard | ID | Seuil | Critique |
|-------|:---|-------|----------|
| WFE (Walk-Forward Efficiency) | - | >=0.6 | OUI |
| Monte Carlo p-value | guard001 | <0.05 | OUI |
| Sensitivity variance | guard002 | <15% | OUI |
| Bootstrap CI lower bound | guard003 | >1.0 | OUI |
| Top 10 trades contribution | guard005 | <40% | OUI |
| Stress1 Sharpe | guard006 | >1.0 | OUI |
| Regime mismatch | guard007 | <1% | OUI |
| **Regime Stress (SIDEWAYS)** | **guard008** | **Sharpe > 0** | **OUI** ⚡ NEW |

**GATE: 8/8 PASS obligatoire avant tout merge.**

## PATTERNS PYTHON OBLIGATOIRES

### Anti Look-Ahead
```python
# TOUJOURS utiliser .shift(1) pour les features rolling
signal = indicator.shift(1)  # CORRECT
# signal = indicator  # INTERDIT - look-ahead
```

### TP Progression
```python
# TOUJOURS verifier la progression des TP
assert tp1 < tp2 < tp3, "TP must be progressive"
# Gaps minimum recommandes: 0.5 entre niveaux
```

### Regime Attribution
```python
# Utiliser ENTRY time pour attribution regime, PAS exit
regime = get_regime_at(entry_time)  # CORRECT
# regime = get_regime_at(exit_time)  # INTERDIT
```

## DISPLACEMENT VARIANTS
| Type | Valeur | Assets |
|------|--------|--------|
| Fast (meme) | 26 | JOE, DOGE |
| Standard | 52 | BTC, ETH, majeurs |
| Slow | 65-78 | OSMO, MINA, OP |

## PIEGES CRITIQUES
- NE PAS filtrer SIDEWAYS sans analyse -> distribution variable par asset (voir regime_v3)
- Sharpe >4 ou WFE >2 = SUSPECT -> demander reconciliation
- Min 100 trades IS, 60 OOS
- Slippage fixe 2bps -> devrait etre f(volume) pour altcoins

## GUARD-008: Regime Stress Test ⚡ NEW 26 Jan 2026

**Script:** `scripts/run_regime_stress_test.py`  
**Ajouté:** 26 Jan 2026 (Issue #17 TASK 3)

### Critères
| Régime | PASS | REVIEW | FAIL |
|--------|------|--------|------|
| MARKDOWN | Trades < 10 OR Sharpe ≥ 0 | Sharpe ∈ [-1, 0) sur >10 trades | Sharpe < -1.0 sur >10 trades |
| SIDEWAYS | Sharpe > 0 | Sharpe ∈ [-0.5, 0] | Sharpe < -0.5 |

### Commande
```bash
# Test single asset
python scripts/run_regime_stress_test.py --asset ETH --regime SIDEWAYS

# Test all PROD assets
python scripts/run_regime_stress_test.py --all-assets --regime SIDEWAYS
```

### Cas exclus par ce guard (26 Jan 2026)
| Asset | Régime | Sharpe | Verdict |
|-------|--------|--------|---------|
| EGLD | SIDEWAYS | -4.59 | EXCLU |
| AVAX | SIDEWAYS | -0.36 | EXCLU |

---

## WORKFLOW RESCUE (CRITICAL - Ne jamais skip)
**Reference obligatoire:** `docs/WORKFLOW_MULTI_ASSET_SCREEN_VALIDATE_PROD.md`

**Si guards FAIL (<8/8 PASS):**
```
Phase 2 (FAIL) → Phase 3A (displacement rescue d26/d52/d78)
                     ↓ FAIL
                 Phase 4 (filter grid 12 configs)
                     ↓ FAIL
                 EXCLU DEFINITIF
```

**JAMAIS bloquer sans tenter:**
1. Phase 3A: Displacement grid (d26, d78 si d52 fail)
2. Phase 4: Filter grid (medium_distance_volume, moderate, etc.)

**Exceptions (skip rescue):**
- Donnees < 50 trades OOS
- Structural (WFE < 0.3, Sharpe < 0.8)
- User demande explicitement

**SINON: Rescue OBLIGATOIRE avant EXCLU**

## SOURCE DE VERITE
Toujours lire `status/project-state.md` EN PREMIER.
`docs/HANDOFF.md` est OBSOLETE.
`docs/WORKFLOW_MULTI_ASSET_SCREEN_VALIDATE_PROD.md` pour workflow rescue.
