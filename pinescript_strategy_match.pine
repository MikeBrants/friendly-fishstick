//@version=6
strategy('FINAL TRIGGER v2 - State/Transition + A/D Line + Ichi Light + Stats', overlay = true, max_labels_count = 500, max_lines_count = 500, pyramiding = 0, default_qty_type = strategy.fixed, default_qty_value = 1, initial_capital = 5000, commission_type = strategy.commission.percent, commission_value = 0.05, slippage = 2, process_orders_on_close = true, calc_on_every_tick = false)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INPUTS GÃ‰NÃ‰RAUX
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
strictLock_5in1Last = input.bool(false, 'Strict lock: 5in1 must be last')
requireFamaBetween = input.bool(false, 'Strict MAMA: require FAMA between MAMA and KAMA')

test_entry_btn = input.bool(false, 'ðŸ”¥ TEST ENTRY LONG (Toggle to fire)')
test_tp1_btn = input.bool(false, 'ðŸ”¥ TEST TP1 (Toggle to fire)')

graceBars = input.int(1, 'Grace window (bars)', minval = 0, maxval = 1)
showGrace = input.bool(true, 'Show grace marker')

len = input.int(20, 'Length (MAMA)')
src = input.source(close, 'Source (MAMA)')

TS_D1 = input.int(6, minval = 1, title = 'Tenkan-sen')
KS_D1 = input.int(37, minval = 1, title = 'Kijun-sen')
displacement = input.int(52, minval = 1, title = 'Displacement')

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FILTRES MASTER â€” PUZZLE + 5in1 (UPDATED)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
useMamaKamaFilter = input.bool(true, title = 'ðŸ”Œ PUZZLE: Require MAMA > KAMA alignment')
useDistanceFilter = input.bool(false, title = 'ðŸ”Œ 5in1: Use Distance Filter')
useObvFilter = input.bool(false, title = 'ðŸ”Œ 5in1: Use Volume Filter')
useADLine = input.bool(true, title = '    â””â”€ Use A/D Line (vs classic OBV)')
adNormPeriod = input.int(50, title = '    â””â”€ A/D Norm Period', minval = 10)
useRegCloudFilter = input.bool(false, title = 'ðŸ”Œ 5in1: Use Regression Cloud Filter')
useKamaFilter = input.bool(false, title = 'ðŸ”Œ 5in1: Use KAMA Oscillator Filter')
ichimokuFilter = input.bool(true, title = 'ðŸ”Œ 5in1: Use Ichimoku Filter')
ichi5in1Strict = input.bool(true, title = '    â””â”€ Ichi5in1: Strict 17 cond (vs Light 3)')

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 5in1 TRANSITION MODE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
useTransitionMode = input.bool(false, title = 'âš¡ 5in1: Require transition (vs just state)')

fast_period = input.int(7, title = '5in1 Fast Period')
slow_period = input.int(19, title = '5in1 Slow Period')
er_period = input.int(8, title = '5in1 ER Period')
useNorm = input.bool(true, title = '5in1 Use Normalization')
norm_period = input.int(50, title = '5in1 Norm Lookback')

TS_5 = input.int(9, title = '5in1 Tenkan')
KS_5 = input.int(29, title = '5in1 Kijun')
disp_5 = input.int(52, title = '5in1 Displacement')

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ATR / SL / TP INPUTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
atrLen = input.int(14, 'ATR Length')
slMult = input.float(4.5, 'SL ATR Mult', step = 0.25)
tp1Mult = input.float(4.25, 'TP1 ATR Mult', step = 0.25)
tp2Mult = input.float(7.5, 'TP2 ATR Mult', step = 0.25)
tp3Mult = input.float(9.5, 'TP3 ATR Mult (Runner)', step = 0.5)

showAtrLevels = input.bool(true, 'Show ATR SL/TP (visual backtest)')
holdBars = input.int(50, 'Hold bars (<=500)', minval = 1, maxval = 500)
maxTrades = input.int(120, 'Max trades kept', minval = 10, maxval = 150)
assumeTPBeforeSL = input.bool(false, 'If TP & SL same bar: assume TP first')

capitalUsd = input.float(5000, 'Capital ($)', step = 100)
riskPct = input.float(0.5, 'Risk %', step = 0.1)
qtyStep = input.float(0.001, 'Qty step (exchange)', step = 0.001)

chatId = input.string('-1002304648447', 'Telegram chat_id')
disableWebPreview = input.bool(true, 'Telegram: disable_web_page_preview')

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATS TABLE + DEBUG INPUTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
showStatsTable = input.bool(true, 'ðŸ“Š Show Stats Table')
showHourlyTable = input.bool(false, 'ðŸ“… Show Hourly Stats Table')
showDailyTable = input.bool(false, 'ðŸ“† Show Daily Stats Table')
tablePosition = input.string('top_right', 'Main Table Position', options = ['top_right', 'top_left', 'bottom_right', 'bottom_left'])
hourlyTablePos = input.string('bottom_left', 'Hourly Table Position', options = ['top_right', 'top_left', 'bottom_right', 'bottom_left'])
dailyTablePos = input.string('bottom_right', 'Daily Table Position', options = ['top_right', 'top_left', 'bottom_right', 'bottom_left'])
tableSize = input.string('small', 'Table Size', options = ['tiny', 'small', 'normal'])
showDebug5in1 = input.bool(false, 'ðŸ” DEBUG: Show 5in1 State (bgcolor)')

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 1) MAMA / FAMA / KAMA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PI = 2 * math.asin(1)

hilbertTransform(x) =>
    0.0962 * x + 0.5769 * nz(x[2]) - 0.5769 * nz(x[4]) - 0.0962 * nz(x[6])

computeComponent(x, mesaPeriodMult) =>
    hilbertTransform(x) * mesaPeriodMult

computeAlpha(_src, fastLimit, slowLimit) =>
    float mesaPeriod = 0.0
    float mesaPeriodMult = 0.075 * nz(mesaPeriod[1]) + 0.54
    float smooth = 0.0
    smooth := (4 * _src + 3 * nz(_src[1]) + 2 * nz(_src[2]) + nz(_src[3])) / 10
    float detrender = 0.0
    detrender := computeComponent(smooth, mesaPeriodMult)
    float I1 = nz(detrender[3])
    float Q1 = computeComponent(detrender, mesaPeriodMult)
    float jI = computeComponent(I1, mesaPeriodMult)
    float jQ = computeComponent(Q1, mesaPeriodMult)
    float I2 = 0.0
    float Q2 = 0.0
    I2 := I1 - jQ
    Q2 := Q1 + jI
    I2 := 0.2 * I2 + 0.8 * nz(I2[1])
    Q2 := 0.2 * Q2 + 0.8 * nz(Q2[1])
    float Re = I2 * nz(I2[1]) + Q2 * nz(Q2[1])
    float Im = I2 * nz(Q2[1]) - Q2 * nz(I2[1])
    Re := 0.2 * Re + 0.8 * nz(Re[1])
    Im := 0.2 * Im + 0.8 * nz(Im[1])
    if Re != 0 and Im != 0
        mesaPeriod := 2 * PI / math.atan(Im / Re)
        mesaPeriod
    if mesaPeriod > 1.5 * nz(mesaPeriod[1])
        mesaPeriod := 1.5 * nz(mesaPeriod[1])
        mesaPeriod
    if mesaPeriod < 0.67 * nz(mesaPeriod[1])
        mesaPeriod := 0.67 * nz(mesaPeriod[1])
        mesaPeriod
    if mesaPeriod < 6
        mesaPeriod := 6
        mesaPeriod
    if mesaPeriod > 50
        mesaPeriod := 50
        mesaPeriod
    mesaPeriod := 0.2 * mesaPeriod + 0.8 * nz(mesaPeriod[1])
    float phase = 0.0
    if I1 != 0
        phase := 180 / PI * math.atan(Q1 / I1)
        phase
    float deltaPhase = nz(phase[1]) - phase
    if deltaPhase < 1
        deltaPhase := 1
        deltaPhase
    float alpha = fastLimit / deltaPhase
    if alpha < slowLimit
        alpha := slowLimit
        alpha
    [alpha, alpha / 2.0]

er = math.abs(ta.change(src, len)) / math.sum(math.abs(ta.change(src)), len)
[a, b] = computeAlpha(src, er, er * 0.1)

var float mama = na
var float fama = na
var float kama = na

mama := na(mama[1]) ? src : a * src + (1 - a) * mama[1]
fama := na(fama[1]) ? mama : b * mama + (1 - b) * fama[1]

alphaK = math.pow(er * (b - a) + a, 2)
kama := na(kama[1]) ? src : alphaK * src + (1 - alphaK) * kama[1]

cond_mk_long_base = close > mama and mama > kama
cond_mk_short_base = close < mama and mama < kama

cond_fama_between_long = kama < fama and fama < mama
cond_fama_between_short = mama < fama and fama < kama

cond_mk_long = cond_mk_long_base and (not requireFamaBetween or cond_fama_between_long)
cond_mk_short = cond_mk_short_base and (not requireFamaBetween or cond_fama_between_short)

plot(mama, 'MAMA', color = color.new(color.blue, 0), display = display.none)
plot(kama, 'KAMA', color = color.new(color.red, 0), display = display.none)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 2) ICHIMOKU EXTERNE (PUZZLE)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
donchian(l) =>
    math.avg(ta.lowest(l), ta.highest(l))

Tenkan = donchian(TS_D1)
Kijun = donchian(KS_D1)
KumoA = math.avg(Tenkan, Kijun)
KumoB = donchian(displacement)

KumoA_Offset_25 = KumoA[25]
KumoB_Offset_25 = KumoB[25]
KumoA_Offset_50 = KumoA[50]
KumoB_Offset_50 = KumoB[50]
TS_Offset_25 = Tenkan[25]
KS_Offset_25 = Kijun[25]
TS_Offset_1 = Tenkan[1]
KS_Offset_1 = Kijun[1]
KumoA_Offset_1 = KumoA[1]
KumoB_Offset_1 = KumoB[1]

All_Bullish(x) =>
    cond1 = x > Tenkan and x > Kijun and x > KumoA_Offset_25 and x > KumoB_Offset_25
    cond2 = x > KumoA_Offset_50 and x > KumoB_Offset_50 and x > KS_Offset_25 and x > TS_Offset_25
    cond3 = KumoA > KumoB and KumoA > KumoA_Offset_1 and KumoB > KumoB_Offset_1
    cond4 = Kijun > KS_Offset_1 and Tenkan > TS_Offset_1
    cond1 and cond2 and cond3 and cond4

All_Bearish(x) =>
    x < KumoA_Offset_25 and x < KumoB_Offset_25 and close < KumoB

var bool trade_op = false
var int ichi_state = 0

buy_signal_raw = All_Bullish(close) and not trade_op
sell_signal_raw = All_Bearish(close) and trade_op

buy_signal_close = barstate.isconfirmed and buy_signal_raw
sell_signal_close = barstate.isconfirmed and sell_signal_raw

if barstate.isconfirmed
    if buy_signal_raw
        trade_op := true
        ichi_state := 1
        ichi_state
    else if sell_signal_raw
        trade_op := false
        ichi_state := -1
        ichi_state

ichi_long_active = ichi_state == 1
ichi_short_active = ichi_state == -1

plot(Tenkan, 'Tenkan', color = color.new(color.yellow, 0), display = display.none)
plot(Kijun, 'Kijun', color = color.new(color.gray, 0), display = display.none)

plotshape(buy_signal_close, title = 'ICHI BUY', style = shape.triangleup, location = location.belowbar, color = color.new(color.green, 50), text = 'BUY', textcolor = color.white, size = size.tiny)
plotshape(sell_signal_close, title = 'ICHI SELL', style = shape.triangledown, location = location.abovebar, color = color.new(color.red, 50), text = 'SELL', textcolor = color.white, size = size.tiny)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 3) 5-in-1 COMPOSANTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// --- DISTANCE KAMAS ---
kama5(src_, length) =>
    xPrice = src_
    xvnoise = math.abs(xPrice - xPrice[1])
    nAMA = 0.0
    nfastend = 0.666
    nslowend = 0.0645
    nsignal = math.abs(xPrice - xPrice[length])
    nnoise = math.sum(xvnoise, length)
    nefratio = nnoise != 0 ? nsignal / nnoise : 0
    nsmooth = math.pow(nefratio * (nfastend - nslowend) + nslowend, 2)
    nAMA := nz(nAMA[1]) + nsmooth * (xPrice - nz(nAMA[1]))
    nAMA

src2 = ohlc4
ma05 = kama5(src2, 5)
ma10 = kama5(src2, 10)
ma15 = kama5(src2, 15)
ma20 = kama5(src2, 20)
ma25 = kama5(src2, 25)
ma30 = kama5(src2, 30)
ma35 = kama5(src2, 35)
ma40 = kama5(src2, 40)
ma45 = kama5(src2, 45)
ma50 = kama5(src2, 50)
ma55 = kama5(src2, 55)
ma60 = kama5(src2, 60)
ma65 = kama5(src2, 65)
ma70 = kama5(src2, 70)
ma75 = kama5(src2, 75)
ma80 = kama5(src2, 80)
ma85 = kama5(src2, 85)
ma90 = kama5(src2, 90)
ma100 = kama5(src2, 100)

dist1 = (ma05 - ma10) / ma10 + (ma10 - ma15) / ma15 + (ma15 - ma20) / ma20 + (ma20 - ma25) / ma25 + (ma25 - ma30) / ma30 + (ma30 - ma35) / ma35
dist2 = (ma35 - ma40) / ma40 + (ma40 - ma45) / ma45 + (ma45 - ma50) / ma50 + (ma50 - ma55) / ma55 + (ma55 - ma60) / ma60 + (ma60 - ma65) / ma65
dist3 = (ma65 - ma70) / ma70 + (ma70 - ma75) / ma75 + (ma75 - ma80) / ma80 + (ma80 - ma85) / ma85 + (ma85 - ma90) / ma90 + (ma90 - ma100) / ma100
totalDistance = (dist1 + dist2 + dist3) / 18

// --- VOLUME FILTER: A/D LINE (Chaikin) ou OBV CLASSIC ---
mfm = (close - low - (high - close)) / math.max(high - low, 1e-10)
mfv = mfm * volume
adLine = ta.cum(mfv)

adLowest = ta.lowest(adLine, adNormPeriod)
adHighest = ta.highest(adLine, adNormPeriod)
adNorm = (adLine - adLowest) / math.max(adHighest - adLowest, 1e-10) - 0.5
adSlope = adNorm - nz(adNorm[3])

adBull = adNorm > 0.1 and adSlope > 0
adBear = adNorm < -0.1 and adSlope < 0
adSignal = adBull ? 1 : adBear ? -1 : 0

obvVal = ta.cum(ta.change(close) > 0 ? volume : ta.change(close) < 0 ? -volume : 0)
obvShort = ta.ema(obvVal, 3)
obvMedium = ta.ema(obvVal, 9)
obvLong = ta.ema(obvVal, 21)
obvIsBull = obvShort > obvMedium and obvShort > obvLong
obvIsBear = obvShort < obvMedium and obvShort < obvLong
obvSignalClassic = obvIsBull ? 1 : obvIsBear ? -1 : 0

volSignal = useADLine ? adSignal : obvSignalClassic

// --- REGRESSION CLOUD ---
calcSlope(source, length) =>
    sumX = 0.0
    sumY = 0.0
    sumXSqr = 0.0
    sumXY = 0.0
    for i = 0 to length - 1 by 1
        val = source[length - 1 - i]
        per = i + 1.0
        sumX := sumX + per
        sumY := sumY + val
        sumXSqr := sumXSqr + per * per
        sumXY := sumXY + val * per
        sumXY
    (length * sumXY - sumX * sumY) / (length * sumXSqr - sumX * sumX)

lengthsArray = array.from(10, 20, 50, 100, 200, 300, 400, 500)
slopes = array.new_float()
for ln in lengthsArray
    array.push(slopes, calcSlope(close, ln))

differences = array.new_float()
for i = 0 to array.size(slopes) - 2 by 1
    diff = (array.get(slopes, i) - array.get(slopes, i + 1)) * array.get(lengthsArray, i)
    array.push(differences, diff)

regTotalDistance = array.sum(differences)
baseLine = ta.sma(close, 100)
cloudLine = baseLine + regTotalDistance * 0.1

regAbove = close > math.max(baseLine, cloudLine)
regBelow = close < math.min(baseLine, cloudLine)
regCloudSignal = regAbove ? 1 : regBelow ? -1 : 0

// --- KAMA OSCILLATOR ---
ch = math.abs(close - close[er_period])
volatility = math.sum(math.abs(close - close[1]), er_period)
erVal2 = volatility != 0 ? ch / volatility : 0
sc2 = erVal2 * (2 / (fast_period + 1) - 2 / (slow_period + 1)) + 2 / (slow_period + 1)
kamaVal = ta.ema(close, fast_period) + sc2 * (close - ta.ema(close, fast_period))

lowest = ta.lowest(kamaVal, norm_period)
highest = ta.highest(kamaVal, norm_period)
normalizedKama = (kamaVal - lowest) / math.max(highest - lowest, 1e-10) - 0.5
kamaOsc = useNorm ? normalizedKama : kamaVal
kamaSignal = kamaOsc > 0 ? 1 : kamaOsc < 0 ? -1 : 0

// --- ICHIMOKU 5in1 â€” STRICT vs LIGHT ---
Tenkan5 = donchian(TS_5)
Kijun5 = donchian(KS_5)
KumoA5 = math.avg(Tenkan5, Kijun5)
KumoB5 = donchian(disp_5)

All_Bullish_5(x) =>
    c1 = x > Tenkan5 and x > Kijun5 and x > KumoA5[25] and x > KumoB5[25]
    c2 = x > KumoA5[50] and x > KumoB5[50] and x > Kijun5[25] and x > Tenkan5[25]
    c3 = KumoA5 > KumoB5 and KumoA5 > KumoA5[1] and KumoB5 > KumoB5[1]
    c4 = Kijun5 > Kijun5[1] and Tenkan5 > Tenkan5[1]
    c1 and c2 and c3 and c4

All_Bearish_5_Strict(x) =>
    c1 = x < Tenkan5 and x < Kijun5 and x < KumoA5[25] and x < KumoB5[25]
    c2 = Kijun5 < KumoA5[25] and Kijun5 < KumoB5[25] and Tenkan5 < KumoA5[25] and Tenkan5 < KumoB5[25]
    c3 = Kijun5 < Kijun5[1] and Tenkan5 < Tenkan5[1]
    c4 = x < KumoA5[50] and x < KumoB5[50] and x < Kijun5[25] and x < Tenkan5[25]
    c5 = KumoA5 < KumoB5 and KumoA5 < KumoA5[1] and KumoB5 < KumoB5[1]
    c1 and c2 and c3 and c4 and c5

All_Bearish_5_Light(x) =>
    x < KumoA5[25] and x < KumoB5[25] and close < KumoB5

ichiBearish5 = ichi5in1Strict ? All_Bearish_5_Strict(close) : All_Bearish_5_Light(close)
ichimokuSignal5 = All_Bullish_5(close) ? 1 : ichiBearish5 ? -1 : 0

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 5in1 SIGNAL â€” STATE vs TRANSITION MODE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
distanceBull = not useDistanceFilter or totalDistance > 0
distanceBear = not useDistanceFilter or totalDistance < 0

obvBull = not useObvFilter or volSignal > 0
obvBear = not useObvFilter or volSignal < 0

regCloudBull = not useRegCloudFilter or regCloudSignal > 0
regCloudBear = not useRegCloudFilter or regCloudSignal < 0

kamaBull = not useKamaFilter or kamaSignal > 0
kamaBear = not useKamaFilter or kamaSignal < 0

ichiBull = not ichimokuFilter or ichimokuSignal5 > 0
ichiBear = not ichimokuFilter or ichimokuSignal5 < 0

allBull = distanceBull and obvBull and regCloudBull and kamaBull and ichiBull
allBear = distanceBear and obvBear and regCloudBear and kamaBear and ichiBear

var bool prevAllBull = false
var bool prevAllBear = false

bullishSignal_close = barstate.isconfirmed and allBull and (not useTransitionMode or not prevAllBull)
bearishSignal_close = barstate.isconfirmed and allBear and (not useTransitionMode or not prevAllBear)

if barstate.isconfirmed
    prevAllBull := allBull
    prevAllBear := allBear
    prevAllBear

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DEBUG: 5in1 State Visualizer
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
debugColor = allBull ? color.new(color.green, 85) : allBear ? color.new(color.red, 85) : color.new(color.gray, 85)
bgcolor(showDebug5in1 ? debugColor : na, title = '5in1 State Debug')

plotshape(showDebug5in1 and bullishSignal_close, title = '5in1 â†’ BULL', style = shape.circle, location = location.bottom, color = color.lime, size = size.tiny)
plotshape(showDebug5in1 and bearishSignal_close, title = '5in1 â†’ BEAR', style = shape.circle, location = location.bottom, color = color.red, size = size.tiny)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 4) PUZZLE + Grace1 AVEC MAMA/KAMA BYPASS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cross_long_ok = ta.crossover(mama, kama) and (not requireFamaBetween or cond_fama_between_long)
cross_short_ok = ta.crossunder(mama, kama) and (not requireFamaBetween or cond_fama_between_short)

var bool lock_long_cycle = false
var bool lock_short_cycle = false
var bool pending_long = false
var bool pending_short = false

var bool final_long_active = false
var bool final_short_active = false

var bool new_long_close = false
var bool new_short_close = false
new_long_close := false
new_short_close := false

if barstate.isconfirmed
    armed_long_strict = ichi_long_active and (not useMamaKamaFilter or cond_mk_long)
    armed_short_strict = ichi_short_active and (not useMamaKamaFilter or cond_mk_short)
    armed_long_grace_ok = ichi_long_active and (not useMamaKamaFilter or cond_mk_long or cross_long_ok)
    armed_short_grace_ok = ichi_short_active and (not useMamaKamaFilter or cond_mk_short or cross_short_ok)

    if buy_signal_raw or sell_signal_raw
        lock_long_cycle := false
        lock_short_cycle := false
        pending_long := false
        pending_short := false
        pending_short

    if not ichi_long_active
        final_long_active := false
        final_long_active
    if not ichi_short_active
        final_short_active := false
        final_short_active

    if strictLock_5in1Last and bullishSignal_close and ichi_long_active and not armed_long_strict
        if graceBars == 1
            pending_long := true
            pending_long
        else
            lock_long_cycle := true
            lock_long_cycle

    if strictLock_5in1Last and bearishSignal_close and ichi_short_active and not armed_short_strict
        if graceBars == 1
            pending_short := true
            pending_short
        else
            lock_short_cycle := true
            lock_short_cycle

    if pending_long[1] and not armed_long_grace_ok
        pending_long := false
        if strictLock_5in1Last
            lock_long_cycle := true
            lock_long_cycle

    if pending_short[1] and not armed_short_grace_ok
        pending_short := false
        if strictLock_5in1Last
            lock_short_cycle := true
            lock_short_cycle

    allow_long = not strictLock_5in1Last or not lock_long_cycle
    allow_short = not strictLock_5in1Last or not lock_short_cycle

    pending_long_ok = graceBars == 1 and pending_long[1] and armed_long_grace_ok
    pending_short_ok = graceBars == 1 and pending_short[1] and armed_short_grace_ok

    trigger_long = bullishSignal_close and armed_long_strict or pending_long_ok
    trigger_short = bearishSignal_close and armed_short_strict or pending_short_ok

    new_long = trigger_long and allow_long and not final_long_active
    new_short = trigger_short and allow_short and not final_short_active

    if new_long
        final_long_active := true
        final_short_active := false
        pending_long := false
        new_long_close := true
        new_long_close

    if new_short
        final_short_active := true
        final_long_active := false
        pending_short := false
        new_short_close := true
        new_short_close

plotshape(new_long_close, title = 'FINAL LONG', style = shape.labelup, location = location.belowbar, color = color.green, text = 'LONG', textcolor = color.white, size = size.small)
plotshape(new_short_close, title = 'FINAL SHORT', style = shape.labeldown, location = location.abovebar, color = color.red, text = 'SHORT', textcolor = color.white, size = size.small)

plotshape(showGrace and graceBars == 1 and pending_long, title = 'GRACE LONG', style = shape.circle, location = location.belowbar, color = color.yellow, size = size.tiny, text = 'G')
plotshape(showGrace and graceBars == 1 and pending_short, title = 'GRACE SHORT', style = shape.circle, location = location.abovebar, color = color.yellow, size = size.tiny, text = 'G')

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 5) ATR SL/TP â€” Backtest visuel
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
atr = ta.atr(atrLen)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 5a) STRATEGY EXECUTION â€” MULTI-TP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
riskUsd = capitalUsd * riskPct / 100.0

var int strat_leg_state = 0
var int strat_dir = 0
var float strat_entry = na
var float strat_sl = na
var float strat_tp1 = na
var float strat_tp2 = na
var float strat_tp3 = na

strat_pos_open = strategy.position_size != 0
strat_pos_closed = strategy.position_size == 0 and strategy.position_size[1] != 0
strat_pos_decreased = strat_pos_open and math.abs(strategy.position_size) < math.abs(strategy.position_size[1])

if strat_pos_decreased
    if strat_leg_state == 1
        strat_leg_state := 2
        strat_sl := strat_entry
    else if strat_leg_state == 2
        strat_leg_state := 3
        strat_sl := strat_tp1

if strat_pos_closed
    strat_leg_state := 0
    strat_dir := 0
    strat_entry := na
    strat_sl := na
    strat_tp1 := na
    strat_tp2 := na
    strat_tp3 := na

strat_exec_long = new_long_close and strategy.position_size == 0
strat_exec_short = new_short_close and strategy.position_size == 0

strat_stop_dist = slMult * atr
strat_qty_raw = strat_stop_dist > 0 ? riskUsd / strat_stop_dist : na
strat_qty_total = not na(strat_qty_raw) ? math.floor(strat_qty_raw / qtyStep) * qtyStep : na

if strat_exec_long and not na(strat_qty_total) and strat_qty_total > 0
    strat_dir := 1
    strat_entry := close
    strat_sl := close - slMult * atr
    strat_tp1 := close + tp1Mult * atr
    strat_tp2 := close + tp2Mult * atr
    strat_tp3 := close + tp3Mult * atr
    strat_leg_state := 1
    strategy.entry('Long', strategy.long, qty = strat_qty_total)

if strat_exec_short and not na(strat_qty_total) and strat_qty_total > 0
    strat_dir := -1
    strat_entry := close
    strat_sl := close + slMult * atr
    strat_tp1 := close - tp1Mult * atr
    strat_tp2 := close - tp2Mult * atr
    strat_tp3 := close - tp3Mult * atr
    strat_leg_state := 1
    strategy.entry('Short', strategy.short, qty = strat_qty_total)

if strat_leg_state == 1 and strat_dir == 1
    strategy.exit('LX1', 'Long', qty_percent = 50, limit = strat_tp1, stop = strat_sl)
if strat_leg_state == 2 and strat_dir == 1
    strategy.exit('LX2', 'Long', qty_percent = 60, limit = strat_tp2, stop = strat_sl)
if strat_leg_state == 3 and strat_dir == 1
    strategy.exit('LX3', 'Long', qty_percent = 100, limit = strat_tp3, stop = strat_sl)

if strat_leg_state == 1 and strat_dir == -1
    strategy.exit('SX1', 'Short', qty_percent = 50, limit = strat_tp1, stop = strat_sl)
if strat_leg_state == 2 and strat_dir == -1
    strategy.exit('SX2', 'Short', qty_percent = 60, limit = strat_tp2, stop = strat_sl)
if strat_leg_state == 3 and strat_dir == -1
    strategy.exit('SX3', 'Short', qty_percent = 100, limit = strat_tp3, stop = strat_sl)


var array<line> L_sl = array.new_line()
var array<line> L_tp1 = array.new_line()
var array<line> L_tp2 = array.new_line()
var array<line> L_tp3 = array.new_line()

var array<int> D_dir = array.new_int()
var array<int> B_ent = array.new_int()
var array<float> P_sl = array.new_float()
var array<float> P_tp1 = array.new_float()
var array<float> P_tp2 = array.new_float()
var array<float> P_tp3 = array.new_float()
var array<bool> H_tp1 = array.new_bool()
var array<bool> H_tp2 = array.new_bool()
var array<bool> H_tp3 = array.new_bool()
var array<bool> H_stop = array.new_bool()

f_deleteOldest() =>
    line.delete(array.shift(L_sl))
    line.delete(array.shift(L_tp1))
    line.delete(array.shift(L_tp2))
    line.delete(array.shift(L_tp3))
    array.shift(D_dir)
    array.shift(B_ent)
    array.shift(P_sl)
    array.shift(P_tp1)
    array.shift(P_tp2)
    array.shift(P_tp3)
    array.shift(H_tp1)
    array.shift(H_tp2)
    array.shift(H_tp3)
    array.shift(H_stop)

f_trim() =>
    while array.size(L_sl) > maxTrades
        f_deleteOldest()

f_addTrade(_dir) =>
    if showAtrLevels
        entry = close
        sl = _dir == 1 ? entry - slMult * atr : entry + slMult * atr
        tp1 = _dir == 1 ? entry + tp1Mult * atr : entry - tp1Mult * atr
        tp2 = _dir == 1 ? entry + tp2Mult * atr : entry - tp2Mult * atr
        tp3 = _dir == 1 ? entry + tp3Mult * atr : entry - tp3Mult * atr
        lsl = line.new(bar_index, sl, bar_index + holdBars, sl, color = color.red, width = 1, style = line.style_dashed)
        ltp1 = line.new(bar_index, tp1, bar_index + holdBars, tp1, color = color.yellow, width = 1, style = line.style_dashed)
        ltp2 = line.new(bar_index, tp2, bar_index + holdBars, tp2, color = color.orange, width = 1, style = line.style_dashed)
        ltp3 = line.new(bar_index, tp3, bar_index + holdBars, tp3, color = color.aqua, width = 1, style = line.style_dotted)
        array.push(L_sl, lsl)
        array.push(L_tp1, ltp1)
        array.push(L_tp2, ltp2)
        array.push(L_tp3, ltp3)
        array.push(D_dir, _dir)
        array.push(B_ent, bar_index)
        array.push(P_sl, sl)
        array.push(P_tp1, tp1)
        array.push(P_tp2, tp2)
        array.push(P_tp3, tp3)
        array.push(H_tp1, false)
        array.push(H_tp2, false)
        array.push(H_tp3, false)
        array.push(H_stop, false)
        f_trim()

if new_long_close
    f_addTrade(1)
if new_short_close
    f_addTrade(-1)

if showAtrLevels and array.size(L_sl) > 0
    for i = array.size(L_sl) - 1 to 0 by 1
        dir = array.get(D_dir, i)
        entB = array.get(B_ent, i)
        sl = array.get(P_sl, i)
        tp1 = array.get(P_tp1, i)
        tp2 = array.get(P_tp2, i)
        tp3 = array.get(P_tp3, i)
        hit1 = array.get(H_tp1, i)
        hit2 = array.get(H_tp2, i)
        hit3 = array.get(H_tp3, i)
        stopd = array.get(H_stop, i)
        lsl = array.get(L_sl, i)
        ltp1 = array.get(L_tp1, i)
        ltp2 = array.get(L_tp2, i)
        ltp3 = array.get(L_tp3, i)
        expired = bar_index > entB + holdBars
        if expired and not stopd and not hit3
            line.set_color(lsl, color.gray)
            line.set_color(ltp1, color.gray)
            line.set_color(ltp2, color.gray)
            line.set_color(ltp3, color.gray)
        if not expired and not stopd and not hit3
            hitSL = dir == 1 ? low <= sl : high >= sl
            hitTP1 = dir == 1 ? high >= tp1 : low <= tp1
            hitTP2 = dir == 1 ? high >= tp2 : low <= tp2
            hitTP3 = dir == 1 ? high >= tp3 : low <= tp3
            if hitSL and (not assumeTPBeforeSL or not(hitTP1 or hitTP2 or hitTP3))
                array.set(H_stop, i, true)
                line.set_color(lsl, color.red)
                line.set_style(lsl, line.style_solid)
                line.set_color(ltp1, color.gray)
                line.set_color(ltp2, color.gray)
                line.set_color(ltp3, color.gray)
                line.set_xy2(lsl, bar_index, sl)
                line.set_xy2(ltp1, bar_index, tp1)
                line.set_xy2(ltp2, bar_index, tp2)
                line.set_xy2(ltp3, bar_index, tp3)
            else
                if hitTP1 and not hit1
                    array.set(H_tp1, i, true)
                    line.set_color(ltp1, color.lime)
                    line.set_style(ltp1, line.style_solid)
                if hitTP2 and not hit2
                    array.set(H_tp1, i, true)
                    array.set(H_tp2, i, true)
                    line.set_color(ltp1, color.lime)
                    line.set_style(ltp1, line.style_solid)
                    line.set_color(ltp2, color.lime)
                    line.set_style(ltp2, line.style_solid)
                if hitTP3
                    array.set(H_tp1, i, true)
                    array.set(H_tp2, i, true)
                    array.set(H_tp3, i, true)
                    line.set_color(ltp1, color.lime)
                    line.set_style(ltp1, line.style_solid)
                    line.set_color(ltp2, color.lime)
                    line.set_style(ltp2, line.style_solid)
                    line.set_color(ltp3, color.lime)
                    line.set_style(ltp3, line.style_solid)
                    line.set_xy2(lsl, bar_index, sl)
                    line.set_xy2(ltp1, bar_index, tp1)
                    line.set_xy2(ltp2, bar_index, tp2)
                    line.set_xy2(ltp3, bar_index, tp3)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 5b) BACKTEST STATS + HOURLY/DAILY TRACKING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var int stat_tp1 = 0
var int stat_tp2 = 0
var int stat_tp3 = 0
var int stat_sl = 0

var int stat_dir = 0
var float stat_entry = na
var float stat_slPrice = na
var float stat_tp1Price = na
var float stat_tp2Price = na
var float stat_tp3Price = na
var bool stat_tp1Hit = false
var bool stat_tp2Hit = false
var bool stat_tp3Hit = false
var bool stat_closed = true
var int stat_entryBar = na

// Hourly stats - 6 blocs de 4h (index 0-5)
var array<int> hourly_trades = array.new_int(6, 0)
var array<int> hourly_wins = array.new_int(6, 0)
var array<float> hourly_pnl = array.new_float(6, 0.0)

// Daily stats - 7 jours (index 0=Dim, 1=Lun... 6=Sam)
var array<int> daily_trades = array.new_int(7, 0)
var array<int> daily_wins = array.new_int(7, 0)
var array<float> daily_pnl = array.new_float(7, 0.0)

// Track entry hour/day pour attribution au close
var int trade_entry_hour_block = na
var int trade_entry_day = na
var bool hourly_daily_recorded = false

// P&L par rÃ©sultat
rr_tp1 = tp1Mult / slMult
rr_tp2 = tp2Mult / slMult
rr_tp3 = tp3Mult / slMult

pnl_per_tp1 = 0.50 * rr_tp1
pnl_per_tp2 = 0.50 * rr_tp1 + 0.30 * rr_tp2 + 0.20 * rr_tp1
pnl_per_tp3 = 0.50 * rr_tp1 + 0.30 * rr_tp2 + 0.20 * rr_tp3
pnl_per_sl = -1.0

if new_long_close or new_short_close
    stat_dir := new_long_close ? 1 : -1
    stat_entry := close
    stat_slPrice := new_long_close ? close - slMult * atr : close + slMult * atr
    stat_tp1Price := new_long_close ? close + tp1Mult * atr : close - tp1Mult * atr
    stat_tp2Price := new_long_close ? close + tp2Mult * atr : close - tp2Mult * atr
    stat_tp3Price := new_long_close ? close + tp3Mult * atr : close - tp3Mult * atr
    stat_tp1Hit := false
    stat_tp2Hit := false
    stat_tp3Hit := false
    stat_closed := false
    stat_entryBar := bar_index
    trade_entry_hour_block := math.floor(hour(time, 'UTC') / 4)
    trade_entry_day := dayofweek(time, 'UTC')
    hourly_daily_recorded := false
    hourly_daily_recorded

canCheckStat = not stat_closed and not na(stat_entryBar) and bar_index > stat_entryBar

if canCheckStat
    hitTP1stat = stat_dir == 1 ? high >= stat_tp1Price : low <= stat_tp1Price
    hitTP2stat = stat_dir == 1 ? high >= stat_tp2Price : low <= stat_tp2Price
    hitTP3stat = stat_dir == 1 ? high >= stat_tp3Price : low <= stat_tp3Price
    hitSLstat = stat_dir == 1 ? low <= stat_slPrice : high >= stat_slPrice

    if hitTP1stat and not stat_tp1Hit
        stat_tp1Hit := true
        stat_slPrice := stat_entry
        stat_slPrice

    if hitTP2stat and not stat_tp2Hit
        stat_tp2Hit := true
        stat_slPrice := stat_tp1Price
        stat_slPrice

    if hitTP3stat and not stat_tp3Hit
        stat_tp3Hit := true
        stat_tp3 := stat_tp3 + 1
        stat_closed := true
        stat_closed

    slAllowedStat = not assumeTPBeforeSL or not(hitTP1stat or hitTP2stat or hitTP3stat)
    if hitSLstat and slAllowedStat and not stat_closed
        if stat_tp2Hit
            stat_tp2 := stat_tp2 + 1
            stat_tp2
        else if stat_tp1Hit
            stat_tp1 := stat_tp1 + 1
            stat_tp1
        else
            stat_sl := stat_sl + 1
            stat_sl
        stat_closed := true
        stat_closed

    // Record hourly/daily stats quand trade se ferme
    if stat_closed and not hourly_daily_recorded and not na(trade_entry_hour_block) and not na(trade_entry_day)
        hourly_daily_recorded := true

        hb = trade_entry_hour_block
        dd = trade_entry_day - 1
        if dd < 0
            dd := 6
            dd

        float trade_pnl_r = 0.0
        bool is_win = false

        if stat_tp3Hit
            trade_pnl_r := pnl_per_tp3
            is_win := true
            is_win
        else if stat_tp2Hit
            trade_pnl_r := pnl_per_tp2
            is_win := true
            is_win
        else if stat_tp1Hit
            trade_pnl_r := pnl_per_tp1
            is_win := true
            is_win
        else
            trade_pnl_r := pnl_per_sl
            is_win := false
            is_win

        array.set(hourly_trades, hb, array.get(hourly_trades, hb) + 1)
        if is_win
            array.set(hourly_wins, hb, array.get(hourly_wins, hb) + 1)
        array.set(hourly_pnl, hb, array.get(hourly_pnl, hb) + trade_pnl_r * (capitalUsd * riskPct / 100))

        array.set(daily_trades, dd, array.get(daily_trades, dd) + 1)
        if is_win
            array.set(daily_wins, dd, array.get(daily_wins, dd) + 1)
        array.set(daily_pnl, dd, array.get(daily_pnl, dd) + trade_pnl_r * (capitalUsd * riskPct / 100))

stat_total = stat_tp1 + stat_tp2 + stat_tp3 + stat_sl
stat_winners = stat_tp1 + stat_tp2 + stat_tp3
stat_wr = stat_total > 0 ? stat_winners / stat_total * 100 : 0.0
stat_tp1_rate = stat_total > 0 ? stat_winners / stat_total * 100 : 0.0

stat_pnl_r = stat_tp1 * pnl_per_tp1 + stat_tp2 * pnl_per_tp2 + stat_tp3 * pnl_per_tp3 + stat_sl * pnl_per_sl
stat_pnl_usd = stat_pnl_r * (capitalUsd * riskPct / 100)
stat_per_trade = stat_total > 0 ? stat_pnl_usd / stat_total : 0.0
stat_expectancy = stat_total > 0 ? stat_pnl_r / stat_total : 0.0

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAIN STATS TABLE â€” ENRICHI
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var table statsTable = na

if showStatsTable
    tPos = tablePosition == 'top_right' ? position.top_right : tablePosition == 'top_left' ? position.top_left : tablePosition == 'bottom_right' ? position.bottom_right : position.bottom_left
    tSize = tableSize == 'tiny' ? size.tiny : tableSize == 'small' ? size.small : size.normal

    if na(statsTable)
        statsTable := table.new(tPos, 2, 13, bgcolor = color.rgb(30, 30, 30), border_width = 1, border_color = color.gray)
        statsTable

    table.cell(statsTable, 0, 0, 'ðŸ“Š BACKTEST', text_color = color.white, text_size = tSize, bgcolor = color.rgb(50, 50, 120))
    table.cell(statsTable, 1, 0, syminfo.ticker, text_color = color.yellow, text_size = tSize, bgcolor = color.rgb(50, 50, 120))

    table.cell(statsTable, 0, 1, 'TF', text_color = color.gray, text_size = tSize, bgcolor = color.rgb(35, 35, 35))
    table.cell(statsTable, 1, 1, timeframe.period, text_color = color.white, text_size = tSize, bgcolor = color.rgb(35, 35, 35))

    table.cell(statsTable, 0, 2, 'Trades', text_color = color.silver, text_size = tSize, bgcolor = color.rgb(40, 40, 40))
    table.cell(statsTable, 1, 2, str.tostring(stat_total), text_color = color.white, text_size = tSize, bgcolor = color.rgb(40, 40, 40))

    table.cell(statsTable, 0, 3, 'TP1', text_color = color.rgb(255, 220, 100), text_size = tSize, bgcolor = color.rgb(50, 50, 30))
    table.cell(statsTable, 1, 3, str.tostring(stat_tp1), text_color = color.rgb(255, 220, 100), text_size = tSize, bgcolor = color.rgb(50, 50, 30))

    table.cell(statsTable, 0, 4, 'TP2', text_color = color.orange, text_size = tSize, bgcolor = color.rgb(60, 40, 20))
    table.cell(statsTable, 1, 4, str.tostring(stat_tp2), text_color = color.orange, text_size = tSize, bgcolor = color.rgb(60, 40, 20))

    table.cell(statsTable, 0, 5, 'TP3 ðŸš€', text_color = color.aqua, text_size = tSize, bgcolor = color.rgb(20, 50, 60))
    table.cell(statsTable, 1, 5, str.tostring(stat_tp3), text_color = color.aqua, text_size = tSize, bgcolor = color.rgb(20, 50, 60))

    table.cell(statsTable, 0, 6, 'SL', text_color = color.rgb(255, 100, 100), text_size = tSize, bgcolor = color.rgb(60, 30, 30))
    table.cell(statsTable, 1, 6, str.tostring(stat_sl), text_color = color.rgb(255, 100, 100), text_size = tSize, bgcolor = color.rgb(60, 30, 30))

    wrColor = stat_wr >= 60 ? color.lime : stat_wr >= 50 ? color.yellow : color.rgb(255, 100, 100)
    table.cell(statsTable, 0, 7, 'Win Rate', text_color = color.silver, text_size = tSize, bgcolor = color.rgb(40, 40, 40))
    table.cell(statsTable, 1, 7, str.tostring(stat_wr, '#.#') + '%', text_color = wrColor, text_size = tSize, bgcolor = color.rgb(40, 40, 40))

    tp1RateColor = stat_tp1_rate >= 75 ? color.lime : stat_tp1_rate >= 60 ? color.yellow : color.rgb(255, 100, 100)
    table.cell(statsTable, 0, 8, 'TP1 Rate', text_color = color.silver, text_size = tSize, bgcolor = color.rgb(45, 45, 45))
    table.cell(statsTable, 1, 8, str.tostring(stat_tp1_rate, '#.#') + '%', text_color = tp1RateColor, text_size = tSize, bgcolor = color.rgb(45, 45, 45))

    expColor = stat_expectancy >= 0.3 ? color.lime : stat_expectancy >= 0 ? color.yellow : color.rgb(255, 100, 100)
    table.cell(statsTable, 0, 9, 'Expect', text_color = color.silver, text_size = tSize, bgcolor = color.rgb(40, 40, 40))
    table.cell(statsTable, 1, 9, str.tostring(stat_expectancy, '#.##') + 'R', text_color = expColor, text_size = tSize, bgcolor = color.rgb(40, 40, 40))

    pnlColor = stat_pnl_usd >= 0 ? color.lime : color.rgb(255, 100, 100)
    pnlBg = stat_pnl_usd >= 0 ? color.rgb(20, 50, 20) : color.rgb(60, 30, 30)
    table.cell(statsTable, 0, 10, 'P&L', text_color = color.silver, text_size = tSize, bgcolor = pnlBg)
    table.cell(statsTable, 1, 10, '$' + str.tostring(stat_pnl_usd, '#.#'), text_color = pnlColor, text_size = tSize, bgcolor = pnlBg)

    ptColor = stat_per_trade >= 3 ? color.lime : stat_per_trade >= 0 ? color.yellow : color.rgb(255, 100, 100)
    table.cell(statsTable, 0, 11, '$/trade', text_color = color.silver, text_size = tSize, bgcolor = color.rgb(40, 40, 40))
    table.cell(statsTable, 1, 11, '$' + str.tostring(stat_per_trade, '#.##'), text_color = ptColor, text_size = tSize, bgcolor = color.rgb(40, 40, 40))

    slTpTxt = str.tostring(slMult, '#.#') + '/' + str.tostring(tp1Mult, '#.#') + '/' + str.tostring(tp2Mult, '#.#') + '/' + str.tostring(tp3Mult, '#.#')
    table.cell(statsTable, 0, 12, 'SL/TP', text_color = color.gray, text_size = tSize, bgcolor = color.rgb(30, 30, 30))
    table.cell(statsTable, 1, 12, slTpTxt, text_color = color.gray, text_size = tSize, bgcolor = color.rgb(30, 30, 30))

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HOURLY STATS TABLE (4h blocks)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var table hourlyTable = na

f_hourLabel(int idx) =>
    switch idx
        0 => '00-04'
        1 => '04-08'
        2 => '08-12'
        3 => '12-16'
        4 => '16-20'
        5 => '20-24'
        => '?'

if showHourlyTable and barstate.islast
    hPos = hourlyTablePos == 'top_right' ? position.top_right : hourlyTablePos == 'top_left' ? position.top_left : hourlyTablePos == 'bottom_right' ? position.bottom_right : position.bottom_left
    hSize = tableSize == 'tiny' ? size.tiny : tableSize == 'small' ? size.small : size.normal

    if na(hourlyTable)
        hourlyTable := table.new(hPos, 4, 8, bgcolor = color.rgb(25, 25, 35), border_width = 1, border_color = color.rgb(60, 60, 80))
        hourlyTable

    table.cell(hourlyTable, 0, 0, 'ðŸ• UTC', text_color = color.white, text_size = hSize, bgcolor = color.rgb(40, 40, 80))
    table.cell(hourlyTable, 1, 0, 'Trades', text_color = color.white, text_size = hSize, bgcolor = color.rgb(40, 40, 80))
    table.cell(hourlyTable, 2, 0, 'WR', text_color = color.white, text_size = hSize, bgcolor = color.rgb(40, 40, 80))
    table.cell(hourlyTable, 3, 0, '$/tr', text_color = color.white, text_size = hSize, bgcolor = color.rgb(40, 40, 80))

    float bestPpt = -999999.0
    float worstPpt = 999999.0
    int bestIdx = -1
    int worstIdx = -1

    for i = 0 to 5 by 1
        ht = array.get(hourly_trades, i)
        if ht > 0
            hp = array.get(hourly_pnl, i)
            ppt = hp / ht
            if ppt > bestPpt
                bestPpt := ppt
                bestIdx := i
                bestIdx
            if ppt < worstPpt
                worstPpt := ppt
                worstIdx := i
                worstIdx

    for i = 0 to 5 by 1
        ht = array.get(hourly_trades, i)
        hw = array.get(hourly_wins, i)
        hp = array.get(hourly_pnl, i)

        hwr = ht > 0 ? hw / ht * 100 : 0.0
        hppt = ht > 0 ? hp / ht : 0.0

        rowBg = i == bestIdx ? color.rgb(20, 50, 20) : i == worstIdx ? color.rgb(50, 20, 20) : color.rgb(35, 35, 45)
        wrCol = hwr >= 60 ? color.lime : hwr >= 50 ? color.yellow : color.rgb(255, 100, 100)
        pptCol = hppt >= 3 ? color.lime : hppt >= 0 ? color.yellow : color.rgb(255, 100, 100)

        indicator = i == bestIdx ? ' âœ…' : i == worstIdx ? ' âš ï¸' : ''

        table.cell(hourlyTable, 0, i + 1, f_hourLabel(i) + indicator, text_color = color.silver, text_size = hSize, bgcolor = rowBg)
        table.cell(hourlyTable, 1, i + 1, str.tostring(ht), text_color = color.white, text_size = hSize, bgcolor = rowBg)
        table.cell(hourlyTable, 2, i + 1, ht > 0 ? str.tostring(hwr, '#.#') + '%' : '-', text_color = ht > 0 ? wrCol : color.gray, text_size = hSize, bgcolor = rowBg)
        table.cell(hourlyTable, 3, i + 1, ht > 0 ? '$' + str.tostring(hppt, '#.#') : '-', text_color = ht > 0 ? pptCol : color.gray, text_size = hSize, bgcolor = rowBg)

    totalHT = 0
    totalHW = 0
    totalHP = 0.0
    for i = 0 to 5 by 1
        totalHT := totalHT + array.get(hourly_trades, i)
        totalHW := totalHW + array.get(hourly_wins, i)
        totalHP := totalHP + array.get(hourly_pnl, i)
        totalHP

    totalHWR = totalHT > 0 ? totalHW / totalHT * 100 : 0.0
    totalHPPT = totalHT > 0 ? totalHP / totalHT : 0.0

    table.cell(hourlyTable, 0, 7, 'TOTAL', text_color = color.white, text_size = hSize, bgcolor = color.rgb(50, 50, 80))
    table.cell(hourlyTable, 1, 7, str.tostring(totalHT), text_color = color.white, text_size = hSize, bgcolor = color.rgb(50, 50, 80))
    table.cell(hourlyTable, 2, 7, str.tostring(totalHWR, '#.#') + '%', text_color = color.white, text_size = hSize, bgcolor = color.rgb(50, 50, 80))
    table.cell(hourlyTable, 3, 7, '$' + str.tostring(totalHPPT, '#.#'), text_color = color.white, text_size = hSize, bgcolor = color.rgb(50, 50, 80))

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DAILY STATS TABLE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var table dailyTable = na

f_dayLabel(int idx) =>
    switch idx
        0 => 'Sun'
        1 => 'Mon'
        2 => 'Tue'
        3 => 'Wed'
        4 => 'Thu'
        5 => 'Fri'
        6 => 'Sat'
        => '?'

if showDailyTable and barstate.islast
    dPos = dailyTablePos == 'top_right' ? position.top_right : dailyTablePos == 'top_left' ? position.top_left : dailyTablePos == 'bottom_right' ? position.bottom_right : position.bottom_left
    dSize = tableSize == 'tiny' ? size.tiny : tableSize == 'small' ? size.small : size.normal

    if na(dailyTable)
        dailyTable := table.new(dPos, 4, 9, bgcolor = color.rgb(25, 30, 25), border_width = 1, border_color = color.rgb(60, 80, 60))
        dailyTable

    table.cell(dailyTable, 0, 0, 'ðŸ“† Day', text_color = color.white, text_size = dSize, bgcolor = color.rgb(40, 60, 40))
    table.cell(dailyTable, 1, 0, 'Trades', text_color = color.white, text_size = dSize, bgcolor = color.rgb(40, 60, 40))
    table.cell(dailyTable, 2, 0, 'WR', text_color = color.white, text_size = dSize, bgcolor = color.rgb(40, 60, 40))
    table.cell(dailyTable, 3, 0, '$/tr', text_color = color.white, text_size = dSize, bgcolor = color.rgb(40, 60, 40))

    float bestDPpt = -999999.0
    float worstDPpt = 999999.0
    int bestDIdx = -1
    int worstDIdx = -1

    for i = 0 to 6 by 1
        dt = array.get(daily_trades, i)
        if dt > 0
            dp = array.get(daily_pnl, i)
            dppt = dp / dt
            if dppt > bestDPpt
                bestDPpt := dppt
                bestDIdx := i
                bestDIdx
            if dppt < worstDPpt
                worstDPpt := dppt
                worstDIdx := i
                worstDIdx

    for i = 0 to 6 by 1
        dt = array.get(daily_trades, i)
        dw = array.get(daily_wins, i)
        dp = array.get(daily_pnl, i)

        dwr = dt > 0 ? dw / dt * 100 : 0.0
        dppt = dt > 0 ? dp / dt : 0.0

        rowBg = i == bestDIdx ? color.rgb(20, 50, 20) : i == worstDIdx ? color.rgb(50, 20, 20) : color.rgb(35, 40, 35)
        wrCol = dwr >= 60 ? color.lime : dwr >= 50 ? color.yellow : color.rgb(255, 100, 100)
        pptCol = dppt >= 3 ? color.lime : dppt >= 0 ? color.yellow : color.rgb(255, 100, 100)

        indicator = i == bestDIdx ? ' âœ…' : i == worstDIdx ? ' âš ï¸' : ''

        table.cell(dailyTable, 0, i + 1, f_dayLabel(i) + indicator, text_color = color.silver, text_size = dSize, bgcolor = rowBg)
        table.cell(dailyTable, 1, i + 1, str.tostring(dt), text_color = color.white, text_size = dSize, bgcolor = rowBg)
        table.cell(dailyTable, 2, i + 1, dt > 0 ? str.tostring(dwr, '#.#') + '%' : '-', text_color = dt > 0 ? wrCol : color.gray, text_size = dSize, bgcolor = rowBg)
        table.cell(dailyTable, 3, i + 1, dt > 0 ? '$' + str.tostring(dppt, '#.#') : '-', text_color = dt > 0 ? pptCol : color.gray, text_size = dSize, bgcolor = rowBg)

    totalDT = 0
    totalDW = 0
    totalDP = 0.0
    for i = 0 to 6 by 1
        totalDT := totalDT + array.get(daily_trades, i)
        totalDW := totalDW + array.get(daily_wins, i)
        totalDP := totalDP + array.get(daily_pnl, i)
        totalDP

    totalDWR = totalDT > 0 ? totalDW / totalDT * 100 : 0.0
    totalDPPT = totalDT > 0 ? totalDP / totalDT : 0.0

    table.cell(dailyTable, 0, 8, 'TOTAL', text_color = color.white, text_size = dSize, bgcolor = color.rgb(40, 60, 40))
    table.cell(dailyTable, 1, 8, str.tostring(totalDT), text_color = color.white, text_size = dSize, bgcolor = color.rgb(40, 60, 40))
    table.cell(dailyTable, 2, 8, str.tostring(totalDWR, '#.#') + '%', text_color = color.white, text_size = dSize, bgcolor = color.rgb(40, 60, 40))
    table.cell(dailyTable, 3, 8, '$' + str.tostring(totalDPPT, '#.#'), text_color = color.white, text_size = dSize, bgcolor = color.rgb(40, 60, 40))

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 6) Risk-based Qty + ALERTES TELEGRAM
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
riskUsd = capitalUsd * riskPct / 100.0
kellyPct = 0.3
riskKelly = capitalUsd * kellyPct / 100.0

entryNow = close
slLong = entryNow - slMult * atr
slShort = entryNow + slMult * atr

stopDist = new_long_close ? math.abs(entryNow - slLong) : new_short_close ? math.abs(entryNow - slShort) : na

qtyRaw = (new_long_close or new_short_close) and stopDist > 0 ? riskUsd / stopDist : na
qtyTotal = new_long_close or new_short_close ? math.floor(qtyRaw / qtyStep) * qtyStep : na

qty1 = new_long_close or new_short_close ? math.floor(qtyTotal * 0.50 / qtyStep) * qtyStep : na
qty2 = new_long_close or new_short_close ? math.floor(qtyTotal * 0.30 / qtyStep) * qtyStep : na
qty3 = new_long_close or new_short_close ? math.floor(qtyTotal * 0.20 / qtyStep) * qtyStep : na

qtyKellyRaw = (new_long_close or new_short_close) and stopDist > 0 ? riskKelly / stopDist : na
qtyKelly = new_long_close or new_short_close ? math.floor(qtyKellyRaw / qtyStep) * qtyStep : na

entryAlert = new_long_close or new_short_close ? entryNow : na
slAlert = new_long_close ? slLong : new_short_close ? slShort : na
tp1Alert = new_long_close ? entryNow + tp1Mult * atr : new_short_close ? entryNow - tp1Mult * atr : na
tp2Alert = new_long_close ? entryNow + tp2Mult * atr : new_short_close ? entryNow - tp2Mult * atr : na
tp3Alert = new_long_close ? entryNow + tp3Mult * atr : new_short_close ? entryNow - tp3Mult * atr : na

plot(entryAlert, title = 'ALERT_ENTRY', display = display.none)
plot(slAlert, title = 'ALERT_SL', display = display.none)
plot(tp1Alert, title = 'ALERT_TP1', display = display.none)
plot(tp2Alert, title = 'ALERT_TP2', display = display.none)
plot(tp3Alert, title = 'ALERT_TP3', display = display.none)
plot(qtyTotal, title = 'ALERT_QTY', display = display.none)

fmtDate = 'yyyy-MM-dd HH:mm'
tDisplay = str.format_time(time, fmtDate, 'UTC')
symExch = syminfo.prefix
symTick = syminfo.ticker

f_round(float val, int decimals) =>
    factor = math.pow(10, decimals)
    math.round(val * factor) / factor

jsonEscape(string s) =>
    s1 = str.replace_all(s, '\\', '\\\\')
    s2 = str.replace_all(s1, '"', '\\"')
    s3 = str.replace_all(s2, '\n', '\\n')
    s3

f_json(string _text) =>
    dwp = disableWebPreview ? 'true' : 'false'
    '{"chat_id":"' + chatId + '","text":"' + jsonEscape(_text) + '","disable_web_page_preview":' + dwp + '}'

var bool live_inPos = false
var int live_dir = 0
var float live_entry = na
var float live_sl = na
var float live_tp1 = na
var float live_tp2 = na
var float live_tp3 = na
var float live_qty2 = na
var float live_qty3 = na
var bool live_tp1Sent = false
var bool live_tp2Sent = false
var bool live_tp3Sent = false
var int live_entryBar = na
var int live_beBar = na

var string msgEntry = ''
var string msgTp1 = ''
var string msgTp2 = ''
var string msgTp3 = ''
var string msgExit = ''

if new_long_close
    live_inPos := true
    live_dir := 1
    live_entry := entryAlert
    live_sl := slAlert
    live_tp1 := tp1Alert
    live_tp2 := tp2Alert
    live_tp3 := tp3Alert
    live_qty2 := qty2
    live_qty3 := qty3
    live_tp1Sent := false
    live_tp2Sent := false
    live_tp3Sent := false
    live_entryBar := bar_index
    live_beBar := na
    msgEntry := 'ðŸŸ¢ LONG ' + symTick + '\n\n'
    msgEntry := msgEntry + 'ðŸ“ Entry: ' + str.tostring(f_round(entryAlert, 3)) + '\n'
    msgEntry := msgEntry + 'ðŸ›‘ SL: ' + str.tostring(f_round(slAlert, 3)) + '\n\n'
    msgEntry := msgEntry + 'ðŸ“¦ ORDER 1 (TP1) â€” 50%\n'
    msgEntry := msgEntry + '   Qty: ' + str.tostring(qty1) + '\n'
    msgEntry := msgEntry + '   TP: ' + str.tostring(f_round(tp1Alert, 3)) + '\n\n'
    msgEntry := msgEntry + 'ðŸ“¦ ORDER 2 (TP2) â€” 30%\n'
    msgEntry := msgEntry + '   Qty: ' + str.tostring(qty2) + '\n'
    msgEntry := msgEntry + '   TP: ' + str.tostring(f_round(tp2Alert, 3)) + '\n\n'
    msgEntry := msgEntry + 'ðŸš€ ORDER 3 (RUNNER) â€” 20%\n'
    msgEntry := msgEntry + '   Qty: ' + str.tostring(qty3) + '\n'
    msgEntry := msgEntry + '   TP3: ' + str.tostring(f_round(tp3Alert, 3)) + ' (indicatif)\n'
    msgEntry := msgEntry + '   SL after TP1: ' + str.tostring(f_round(tp1Alert, 3)) + '\n\n'
    msgEntry := msgEntry + 'ðŸ’° Risk ' + str.tostring(riskPct) + '%: ' + str.tostring(qtyTotal) + ' total\n'
    msgEntry := msgEntry + 'âš¡ Kelly (' + str.tostring(kellyPct) + '%): ' + str.tostring(qtyKelly) + ' total\n\n'
    msgEntry := msgEntry + 'ðŸ• ' + tDisplay + ' UTC\n'
    msgEntry := msgEntry + 'ðŸ“Š ' + symExch + ' | ' + timeframe.period
    alert(f_json(msgEntry), alert.freq_once_per_bar_close)

if new_short_close
    live_inPos := true
    live_dir := -1
    live_entry := entryAlert
    live_sl := slAlert
    live_tp1 := tp1Alert
    live_tp2 := tp2Alert
    live_tp3 := tp3Alert
    live_qty2 := qty2
    live_qty3 := qty3
    live_tp1Sent := false
    live_tp2Sent := false
    live_tp3Sent := false
    live_entryBar := bar_index
    live_beBar := na
    msgEntry := 'ðŸ”´ SHORT ' + symTick + '\n\n'
    msgEntry := msgEntry + 'ðŸ“ Entry: ' + str.tostring(f_round(entryAlert, 3)) + '\n'
    msgEntry := msgEntry + 'ðŸ›‘ SL: ' + str.tostring(f_round(slAlert, 3)) + '\n\n'
    msgEntry := msgEntry + 'ðŸ“¦ ORDER 1 (TP1) â€” 50%\n'
    msgEntry := msgEntry + '   Qty: ' + str.tostring(qty1) + '\n'
    msgEntry := msgEntry + '   TP: ' + str.tostring(f_round(tp1Alert, 3)) + '\n\n'
    msgEntry := msgEntry + 'ðŸ“¦ ORDER 2 (TP2) â€” 30%\n'
    msgEntry := msgEntry + '   Qty: ' + str.tostring(qty2) + '\n'
    msgEntry := msgEntry + '   TP: ' + str.tostring(f_round(tp2Alert, 3)) + '\n\n'
    msgEntry := msgEntry + 'ðŸš€ ORDER 3 (RUNNER) â€” 20%\n'
    msgEntry := msgEntry + '   Qty: ' + str.tostring(qty3) + '\n'
    msgEntry := msgEntry + '   TP3: ' + str.tostring(f_round(tp3Alert, 3)) + ' (indicatif)\n'
    msgEntry := msgEntry + '   SL after TP1: ' + str.tostring(f_round(tp1Alert, 3)) + '\n\n'
    msgEntry := msgEntry + 'ðŸ’° Risk ' + str.tostring(riskPct) + '%: ' + str.tostring(qtyTotal) + ' total\n'
    msgEntry := msgEntry + 'âš¡ Kelly (' + str.tostring(kellyPct) + '%): ' + str.tostring(qtyKelly) + ' total\n\n'
    msgEntry := msgEntry + 'ðŸ• ' + tDisplay + ' UTC\n'
    msgEntry := msgEntry + 'ðŸ“Š ' + symExch + ' | ' + timeframe.period
    alert(f_json(msgEntry), alert.freq_once_per_bar_close)

canCheckIntrabar = live_inPos and not na(live_entryBar) and bar_index > live_entryBar

tp1Hit = canCheckIntrabar and not live_tp1Sent and (live_dir == 1 ? high >= live_tp1 : low <= live_tp1)
if tp1Hit
    live_tp1Sent := true
    live_sl := live_entry
    live_beBar := bar_index
    sideEmoji = live_dir == 1 ? 'ðŸŸ¢' : 'ðŸ”´'
    sideTxt = live_dir == 1 ? 'LONG' : 'SHORT'
    msgTp1 := 'âœ… TP1 HIT â€” 50% closed\n\n'
    msgTp1 := msgTp1 + sideEmoji + ' ' + sideTxt + ' ' + symTick + '\n\n'
    msgTp1 := msgTp1 + 'ðŸ“ New SL (BE): ' + str.tostring(f_round(live_entry, 3)) + '\n'
    msgTp1 := msgTp1 + 'ðŸŽ¯ TP1: ' + str.tostring(f_round(live_tp1, 3)) + '\n\n'
    msgTp1 := msgTp1 + 'ðŸ“¦ Remaining:\n'
    msgTp1 := msgTp1 + '   Order 2: ' + str.tostring(live_qty2) + ' â†’ TP2\n'
    msgTp1 := msgTp1 + '   Order 3: ' + str.tostring(live_qty3) + ' â†’ ðŸš€ RUNNER\n'
    msgTp1 := msgTp1 + '   Runner SL: ' + str.tostring(f_round(live_tp1, 3)) + '\n\n'
    msgTp1 := msgTp1 + 'ðŸ• ' + tDisplay + ' UTC\n'
    msgTp1 := msgTp1 + 'ðŸ“Š ' + symExch + ' | ' + timeframe.period
    alert(f_json(msgTp1), alert.freq_once_per_bar)

tp2Hit = canCheckIntrabar and not live_tp2Sent and (live_dir == 1 ? high >= live_tp2 : low <= live_tp2)
if tp2Hit
    live_tp2Sent := true
    sideEmoji = live_dir == 1 ? 'ðŸŸ¢' : 'ðŸ”´'
    sideTxt = live_dir == 1 ? 'LONG' : 'SHORT'
    msgTp2 := 'ðŸŽ¯ TP2 HIT â€” 30% closed\n\n'
    msgTp2 := msgTp2 + sideEmoji + ' ' + sideTxt + ' ' + symTick + '\n\n'
    msgTp2 := msgTp2 + 'ðŸŽ¯ TP2: ' + str.tostring(f_round(live_tp2, 3)) + '\n\n'
    msgTp2 := msgTp2 + 'ðŸš€ RUNNER ACTIVE: ' + str.tostring(live_qty3) + '\n'
    msgTp2 := msgTp2 + '   SL: ' + str.tostring(f_round(live_tp1, 3)) + ' (TP1 level)\n'
    msgTp2 := msgTp2 + '   TP3: ' + str.tostring(f_round(live_tp3, 3)) + ' ðŸŽ¯\n\n'
    msgTp2 := msgTp2 + 'ðŸ• ' + tDisplay + ' UTC\n'
    msgTp2 := msgTp2 + 'ðŸ“Š ' + symExch + ' | ' + timeframe.period
    alert(f_json(msgTp2), alert.freq_once_per_bar)

tp3Hit = canCheckIntrabar and not live_tp3Sent and (live_dir == 1 ? high >= live_tp3 : low <= live_tp3)
if tp3Hit
    live_tp3Sent := true
    sideEmoji = live_dir == 1 ? 'ðŸŸ¢' : 'ðŸ”´'
    sideTxt = live_dir == 1 ? 'LONG' : 'SHORT'
    msgTp3 := 'ðŸ† TP3 HIT â€” RUNNER COMPLETE!\n\n'
    msgTp3 := msgTp3 + sideEmoji + ' ' + sideTxt + ' ' + symTick + '\n\n'
    msgTp3 := msgTp3 + 'ðŸŽ¯ TP3: ' + str.tostring(f_round(live_tp3, 3)) + '\n'
    msgTp3 := msgTp3 + 'ðŸ“¦ Qty: ' + str.tostring(live_qty3) + '\n\n'
    msgTp3 := msgTp3 + 'ðŸ• ' + tDisplay + ' UTC\n'
    msgTp3 := msgTp3 + 'ðŸ“Š ' + symExch + ' | ' + timeframe.period
    alert(f_json(msgTp3), alert.freq_once_per_bar)

beEffective = not live_tp1Sent or not na(live_beBar) and bar_index > live_beBar
slHit = canCheckIntrabar and beEffective and (live_dir == 1 ? low <= live_sl : high >= live_sl)
slAllowed = not assumeTPBeforeSL or not(tp1Hit or tp2Hit or tp3Hit)

if slHit and slAllowed
    sideEmoji = live_dir == 1 ? 'ðŸŸ¢' : 'ðŸ”´'
    sideTxt = live_dir == 1 ? 'LONG' : 'SHORT'
    reasonTxt = live_tp1Sent ? 'BE' : 'SL'
    msgExit := 'ðŸ›‘ EXIT â€” ' + reasonTxt + '\n\n'
    msgExit := msgExit + sideEmoji + ' ' + sideTxt + ' ' + symTick + '\n\n'
    msgExit := msgExit + 'ðŸ“ Exit: ' + str.tostring(f_round(live_sl, 3)) + '\n\n'
    msgExit := msgExit + 'ðŸ• ' + tDisplay + ' UTC\n'
    msgExit := msgExit + 'ðŸ“Š ' + symExch + ' | ' + timeframe.period
    alert(f_json(msgExit), alert.freq_once_per_bar)
    live_inPos := false
    live_dir := 0
    live_entry := na
    live_sl := na
    live_tp1 := na
    live_tp2 := na
    live_tp3 := na
    live_qty2 := na
    live_qty3 := na
    live_tp1Sent := false
    live_tp2Sent := false
    live_tp3Sent := false
    live_entryBar := na
    live_beBar := na
    live_beBar

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 7) BOUTONS DE TEST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var bool testEntrySent = false
var bool testTp1Sent = false

if not test_entry_btn
    testEntrySent := false
    testEntrySent
if not test_tp1_btn
    testTp1Sent := false
    testTp1Sent

if barstate.islast and test_entry_btn and not testEntrySent
    testMsg = 'ðŸ”¥ TEST ALERT ENTRY LONG\nSymbol: ' + symExch + ':' + symTick + '\nPrice: ' + str.tostring(close)
    alert(f_json(testMsg), alert.freq_once_per_bar)
    testEntrySent := true
    testEntrySent

if barstate.islast and test_tp1_btn and not testTp1Sent
    testMsg = 'ðŸ”¥ TEST ALERT TP1 HIT\nSymbol: ' + symExch + ':' + symTick + '\nMoving SL to BE...'
    alert(f_json(testMsg), alert.freq_once_per_bar)
    testTp1Sent := true
    testTp1Sent